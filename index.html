<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Winter Grind" />
    <meta name="theme-color" content="#ea580c" />
    <title>Winter Grind 2025 - Gabriele</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      * { -webkit-tap-highlight-color: transparent; }
      body { overscroll-behavior: none; }
      input:focus { outline: 2px solid #3b82f6; }
      @media (display-mode: standalone) {
        body {
          padding-top: env(safe-area-inset-top);
          padding-bottom: env(safe-area-inset-bottom);
        }
      }
      .sync-indicator {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 1000;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        transition: all 0.3s;
      }
      .sync-ok { background: #10b981; color: white; }
      .sync-saving { background: #f59e0b; color: white; }
      .sync-error { background: #ef4444; color: white; }
      .sync-local { background: #6b7280; color: white; }
    </style>
  </head>
  <body class="bg-gray-50 select-none">
    <div id="sync-status" class="sync-indicator sync-local">üíæ Locale</div>
    <div id="root"></div>

    <script>
      // ============ SYNC STATUS INDICATOR ============
      function updateSyncStatus(status, message) {
        const indicator = document.getElementById('sync-status');
        indicator.className = 'sync-indicator';
        
        switch(status) {
          case 'cloud':
            indicator.className += ' sync-ok';
            indicator.innerHTML = '‚òÅÔ∏è ' + (message || 'Cloud OK');
            break;
          case 'saving':
            indicator.className += ' sync-saving';
            indicator.innerHTML = '‚è≥ ' + (message || 'Salvataggio...');
            break;
          case 'error':
            indicator.className += ' sync-error';
            indicator.innerHTML = '‚ö†Ô∏è ' + (message || 'Errore');
            break;
          case 'local':
            indicator.className += ' sync-local';
            indicator.innerHTML = 'üíæ ' + (message || 'Solo Locale');
            break;
        }
      }

      // ============ INDEXEDDB DATABASE ============
      class WinterGrindDB {
        constructor() {
          this.dbName = "WinterGrindDB";
          this.version = 1;
          this.db = null;
        }

        async init() {
          return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, this.version);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
              this.db = request.result;
              resolve();
            };
            request.onupgradeneeded = (e) => {
              const db = e.target.result;
              if (!db.objectStoreNames.contains("appData")) {
                db.createObjectStore("appData", { keyPath: "id" });
              }
            };
          });
        }

        async save(key, data) {
          return new Promise((resolve, reject) => {
            const tx = this.db.transaction(["appData"], "readwrite");
            const store = tx.objectStore("appData");
            const request = store.put({ id: key, data: data });
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
          });
        }

        async load(key) {
          return new Promise((resolve, reject) => {
            const tx = this.db.transaction(["appData"], "readonly");
            const store = tx.objectStore("appData");
            const request = store.get(key);
            request.onsuccess = () => resolve(request.result ? request.result.data : null);
            request.onerror = () => reject(request.error);
          });
        }
      }

      // ============ STATE MANAGEMENT ============
      let state = {
        currentView: "dashboard",
        weekData: {
          monday: { workout: false, diet: false, cardio: false },
          tuesday: { workout: false, diet: false, cardio: false },
          wednesday: { workout: false, diet: false, cardio: false },
          thursday: { workout: false, diet: false, cardio: false },
          friday: { workout: false, diet: false, cardio: false },
          saturday: { workout: false, diet: false, cardio: false },
          sunday: { workout: false, diet: false, cardio: false },
        },
        weekHistory: [],
        savedWeights: [],
        currentWeek: 1,
        streak: 0,
        totalWeeksCompleted: 0,
        pointsForSgarro: 0,
        // Dati personalizzati dal bot
        userName: 'Atleta',
        userGoal: 'bulk',
        macros: {
          calories: 2200,
          protein: 180,
          carbs: 250,
          fats: 60
        }
      };

      let db;
      let tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
      let tgUser = null;
      let useCloudStorage = false; // Flag per sapere se usiamo cloud

      // ============ TELEGRAM CLOUD STORAGE HELPERS ============
      function cloudAvailable() {
        return !!(window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.CloudStorage);
      }

      function cloudGetItem(key) {
        return new Promise((resolve, reject) => {
          if (!cloudAvailable()) {
            reject(new Error('Cloud Storage non disponibile'));
            return;
          }
          try {
            window.Telegram.WebApp.CloudStorage.getItem(key, (err, value) => {
              if (err) {
                console.error('‚ùå Cloud getItem error:', err);
                reject(err);
              } else {
                console.log('‚úÖ Cloud getItem success');
                resolve(value);
              }
            });
          } catch (e) {
            console.error('‚ùå Cloud getItem exception:', e);
            reject(e);
          }
        });
      }

      function cloudSetItem(key, value) {
        return new Promise((resolve, reject) => {
          if (!cloudAvailable()) {
            reject(new Error('Cloud Storage non disponibile'));
            return;
          }
          try {
            window.Telegram.WebApp.CloudStorage.setItem(key, value, (err) => {
              if (err) {
                console.error('‚ùå Cloud setItem error:', err);
                reject(err);
              } else {
                console.log('‚úÖ Cloud setItem success');
                resolve();
              }
            });
          } catch (e) {
            console.error('‚ùå Cloud setItem exception:', e);
            reject(e);
          }
        });
      }

      // ============ INIT ============
      async function initApp() {
        console.log('üöÄ Inizializzazione app...');
        
        db = new WinterGrindDB();
        await db.init();
        console.log('‚úÖ IndexedDB inizializzato');

        // Telegram WebApp init
        if (tg) {
          try {
            tg.ready();
            tg.expand();
            tgUser = tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : null;
            console.log('‚úÖ Telegram WebApp pronto', tgUser);
          } catch (e) {
            console.warn('‚ö†Ô∏è Telegram WebApp init parziale', e);
          }
        }

        // ---- LEGGI DATI DAL BOT VIA URL ----
        try {
          const params = new URLSearchParams(location.search);
          const dataParam = params.get("data");
          if (dataParam) {
            console.log('üì¶ Dati ricevuti dal bot');
            try {
              const decoded = JSON.parse(atob(decodeURIComponent(dataParam)));
              console.log('üìä Dati decodificati:', decoded);
              
              // Applica i dati ricevuti (merge con stato esistente)
              if (decoded.macros) {
                state.macros = { ...state.macros, ...decoded.macros };
                console.log('‚úÖ Macro aggiornate:', state.macros);
              }
              if (decoded.userName) {
                state.userName = decoded.userName;
                console.log('‚úÖ Nome utente:', state.userName);
              }
              if (decoded.goal) {
                state.userGoal = decoded.goal;
                console.log('‚úÖ Obiettivo:', state.userGoal);
              }
              
              // Applica altri dati (settimana, sgarro, peso, ecc.)
              if (decoded.currentWeek !== undefined) state.currentWeek = decoded.currentWeek;
              if (decoded.pointsForSgarro !== undefined) state.pointsForSgarro = decoded.pointsForSgarro;
              if (decoded.streak !== undefined) state.streak = decoded.streak;
              if (decoded.weekData) state.weekData = { ...state.weekData, ...decoded.weekData };
              if (decoded.savedWeights && Array.isArray(decoded.savedWeights)) {
                // Aggiungi ai pesi esistenti (non sovrascrivere)
                state.savedWeights = [...state.savedWeights, ...decoded.savedWeights];
              }
              
            } catch (e) {
              console.warn('‚ö†Ô∏è Errore parsing dati dal bot:', e);
            }
          }
        } catch (e) {
          console.warn('‚ö†Ô∏è Errore lettura parametri URL:', e);
        }

        // ---- LEGGI DATI DAL BOT VIA URL ----
        try {
          const params = new URLSearchParams(location.search);
          const dataParam = params.get("data");
          if (dataParam) {
            console.log('üì¶ Dati ricevuti dal bot');
            try {
              const decoded = JSON.parse(atob(decodeURIComponent(dataParam)));
              console.log('üìä Dati decodificati:', decoded);
              
              // Applica i dati ricevuti (merge con stato esistente)
              if (decoded.macros) {
                state.macros = { ...state.macros, ...decoded.macros };
                console.log('‚úÖ Macro aggiornate:', state.macros);
              }
              if (decoded.userName) {
                state.userName = decoded.userName;
                console.log('‚úÖ Nome utente:', state.userName);
              }
              if (decoded.goal) {
                state.userGoal = decoded.goal;
                console.log('‚úÖ Obiettivo:', state.userGoal);
              }
              
              // Applica altri dati (settimana, sgarro, peso, ecc.)
              if (decoded.currentWeek !== undefined) state.currentWeek = decoded.currentWeek;
              if (decoded.pointsForSgarro !== undefined) state.pointsForSgarro = decoded.pointsForSgarro;
              if (decoded.streak !== undefined) state.streak = decoded.streak;
              if (decoded.weekData) state.weekData = { ...state.weekData, ...decoded.weekData };
              if (decoded.savedWeights && Array.isArray(decoded.savedWeights)) {
                // Aggiungi ai pesi esistenti (non sovrascrivere)
                state.savedWeights = [...state.savedWeights, ...decoded.savedWeights];
              }
              
            } catch (e) {
              console.warn('‚ö†Ô∏è Errore parsing dati dal bot:', e);
            }
          }
        } catch (e) {
          console.warn('‚ö†Ô∏è Errore lettura parametri URL:', e);
        }

        // PROVA A CARICARE DA CLOUD STORAGE
        if (cloudAvailable()) {
          console.log('‚òÅÔ∏è Cloud Storage disponibile, tentativo di caricamento...');
          updateSyncStatus('saving', 'Caricamento...');
          
          try {
            const cloudRaw = await cloudGetItem("winterGrindState");
            
            if (cloudRaw) {
              const cloudState = JSON.parse(cloudRaw);
              // Merge mantenendo i dati personalizzati appena ricevuti
              state = { 
                ...state, 
                ...cloudState,
                // Mantieni macro, userName, userGoal se appena ricevuti dal bot
                macros: state.macros,
                userName: state.userName,
                userGoal: state.userGoal
              };
              useCloudStorage = true;
              updateSyncStatus('cloud', 'Sincronizzato');
              console.log('‚úÖ Stato caricato da Cloud Storage');
              
              // Salva anche localmente come backup
              await db.save("winterGrindState", state);
            } else {
              console.log('‚ÑπÔ∏è Nessun dato nel Cloud Storage, provo locale...');
              await loadFromLocal();
            }
          } catch (e) {
            console.error('‚ùå Errore Cloud Storage:', e);
            updateSyncStatus('error', 'Errore Cloud');
            
            // Fallback a locale
            await loadFromLocal();
          }
        } else {
          console.log('üíæ Cloud Storage NON disponibile, uso locale');
          updateSyncStatus('local', 'Solo Locale');
          await loadFromLocal();
        }

        render();
      }

      async function loadFromLocal() {
        try {
          const savedData = await db.load("winterGrindState");
          if (savedData) {
            state = { ...state, ...savedData };
            console.log('‚úÖ Stato caricato da IndexedDB locale');
            if (!useCloudStorage) {
              updateSyncStatus('local', 'Solo Locale');
            }
          }
        } catch (e) {
          console.warn('‚ö†Ô∏è Errore caricamento locale:', e);
        }
      }

      async function saveState() {
        updateSyncStatus('saving', 'Salvataggio...');
        
        // Salva SEMPRE su IndexedDB (backup locale)
        try {
          await db.save("winterGrindState", state);
          console.log('‚úÖ Salvato su IndexedDB');
        } catch (e) {
          console.error('‚ùå Errore salvataggio IndexedDB:', e);
        }

        // Se Cloud Storage disponibile, salva anche l√¨
        if (cloudAvailable()) {
          try {
            await cloudSetItem("winterGrindState", JSON.stringify(state));
            useCloudStorage = true;
            updateSyncStatus('cloud', 'Sincronizzato');
            console.log('‚úÖ Salvato su Cloud Storage');
          } catch (e) {
            console.error('‚ùå Errore salvataggio Cloud:', e);
            updateSyncStatus('error', 'Errore sync');
            
            // Mostra notifica all'utente
            if (tg && tg.showAlert) {
              tg.showAlert('‚ö†Ô∏è Errore sincronizzazione cloud. Dati salvati solo localmente.');
            }
          }
        } else {
          updateSyncStatus('local', 'Solo Locale');
        }
      }

      function setState(updates) {
        state = { ...state, ...updates };
        saveState();
        render();
      }

      // ============ UTILS ============
      function calculatePoints() {
        let total = 0;
        Object.values(state.weekData).forEach((data) => {
          if (data.workout) total += 15;
          if (data.cardio) total += 10;
          if (data.diet) total += 3;
        });
        return Math.min(total, 100);
      }

      function getStatusEmoji(points) {
        if (points >= 90) return "üî• BESTIA";
        if (points >= 75) return "üí™ SOLIDO";
        if (points >= 60) return "‚ö° IN RIPRESA";
        return "üö® RESET";
      }

      const workoutSchedule = {
        monday: { name: "Upper A", focus: "Bilanciata" },
        tuesday: { name: "Lower A", focus: "Focus Quadricipiti" },
        wednesday: { name: "Corsa", focus: "20-30 minuti" },
        thursday: { name: "Upper B", focus: "Focus Petto" },
        friday: { name: "Lower B", focus: "Focus Femorali" },
        saturday: { name: "Corsa", focus: "20-30 minuti" },
      };

      const dayNames = {
        monday: "Luned√¨",
        tuesday: "Marted√¨",
        wednesday: "Mercoled√¨",
        thursday: "Gioved√¨",
        friday: "Venerd√¨",
        saturday: "Sabato",
        sunday: "Domenica",
      };

      // ============ ICONS ============
      const icons = {
        trophy: '<svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 9H4.5a2.5 2.5 0 010-5H6m12 0h1.5a2.5 2.5 0 010 5H18M6 9v-4h12v4M6 9v7a6 6 0 0012 0V9M9 21h6"></path></svg>',
        calendar: '<svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"></rect><path d="M16 2v4M8 2v4M3 10h18"></path></svg>',
        dumbbell: '<svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6.5 6.5v11M17.5 6.5v11M2 8.5h2M2 15.5h2M20 8.5h2M20 15.5h2M7 7h10M7 17h10"></path></svg>',
        apple: '<svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 2.69l5.66 5.66a8 8 0 11-11.31 0z"></path><path d="M12 2v5"></path></svg>',
        trend: '<svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M23 6l-9.5 9.5-5-5L1 18"></path><path d="M17 6h6v6"></path></svg>',
        check: '<svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M20 6L9 17l-5-5"></path></svg>',
        circle: '<svg class="w-5 h-5 mx-auto" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle></svg>',
        flame: '<svg class="w-12 h-12" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2c-1.1 0-2 .9-2 2 0 2.2-1.8 4-4 4-1.1 0-2 .9-2 2 0 4.4 3.6 8 8 8s8-3.6 8-8c0-1.1-.9-2-2-2-2.2 0-4-1.8-4-4 0-1.1-.9-2-2-2zm0 14c-2.2 0-4-1.8-4-4 0-.6.1-1.1.3-1.6.7.4 1.5.6 2.3.6 1.9 0 3.5-1.1 4.3-2.7.2.6.3 1.2.3 1.9 0 2.8-2.2 5-5 5z"></path></svg>',
        target: '<svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>',
        award: '<svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="8" r="7"></circle><path d="M8.21 13.89L7 23l5-3 5 3-1.21-9.12"></path></svg>',
      };

      // ============ ACTIONS ============
      window.setView = function (view) {
        setState({ currentView: view });
      };

      window.toggleActivity = function (day, activity) {
        const newWeekData = { ...state.weekData };
        newWeekData[day] = {
          ...newWeekData[day],
          [activity]: !newWeekData[day][activity],
        };
        setState({ weekData: newWeekData });
      };

      window.resetWeek = function () {
        const points = calculatePoints();
        let newStreak = state.streak;
        let newTotal = state.totalWeeksCompleted;
        let newPointsForSgarro = state.pointsForSgarro;

        if (points >= 90) {
          newStreak += 1;
          newTotal += 1;
          newPointsForSgarro += 1;
        } else {
          newStreak = 0;
        }

        const weekToSave = {
          weekNumber: state.currentWeek,
          data: JSON.parse(JSON.stringify(state.weekData)),
          totalPoints: points,
          status: getStatusEmoji(points),
        };

        setState({
          weekHistory: [...state.weekHistory, weekToSave],
          weekData: {
            monday: { workout: false, diet: false, cardio: false },
            tuesday: { workout: false, diet: false, cardio: false },
            wednesday: { workout: false, diet: false, cardio: false },
            thursday: { workout: false, diet: false, cardio: false },
            friday: { workout: false, diet: false, cardio: false },
            saturday: { workout: false, diet: false, cardio: false },
            sunday: { workout: false, diet: false, cardio: false },
          },
          currentWeek: state.currentWeek + 1,
          streak: newStreak,
          totalWeeksCompleted: newTotal,
          pointsForSgarro: newPointsForSgarro,
        });
      };

      window.useSgarro = function () {
        if (state.pointsForSgarro > 0) {
          if (tg && tg.showConfirm) {
            tg.showConfirm(
              'üçï Vuoi usare uno sgarro?\n\nPotrai goderti un pasto libero senza sensi di colpa!',
              (confirmed) => {
                if (confirmed) {
                  setState({ pointsForSgarro: state.pointsForSgarro - 1 });
                  
                  // Notifica il bot dell'uso dello sgarro
                  if (tg && tg.sendData) {
                    tg.sendData(JSON.stringify({
                      type: 'sgarro_used',
                      remainingSgarri: state.pointsForSgarro - 1,
                      timestamp: new Date().toISOString()
                    }));
                  }
                  
                  if (tg && tg.showAlert) {
                    tg.showAlert('‚úÖ Sgarro attivato! Goditelo con moderazione üòã');
                  } else {
                    alert("‚úÖ Sgarro attivato! Goditelo con moderazione üòã");
                  }
                }
              }
            );
          } else {
            if (confirm('üçï Vuoi usare uno sgarro?\n\nPotrai goderti un pasto libero senza sensi di colpa!')) {
              setState({ pointsForSgarro: state.pointsForSgarro - 1 });
              alert("‚úÖ Sgarro attivato! Goditelo con moderazione üòã");
            }
          }
        } else {
          if (tg && tg.showAlert) {
            tg.showAlert('‚ùå Non hai punti sgarro disponibili.\n\nOttieni 90+ punti in una settimana per guadagnarne uno!');
          } else {
            alert("‚ùå Non hai punti sgarro disponibili.\n\nOttieni 90+ punti in una settimana per guadagnarne uno!");
          }
        }
      };

      window.saveWeight = function () {
        const input = document.getElementById("weightInput");
        const weight = parseFloat(input.value);
        if (weight && weight > 0) {
          const newWeights = [...state.savedWeights, { week: state.currentWeek, weight: weight }];
          setState({ savedWeights: newWeights });
          input.value = "";
        }
      };

      // ============ RENDER FUNCTIONS ============
      function renderDashboard() {
        const points = calculatePoints();
        const workouts = Object.values(state.weekData).filter((d) => d.workout).length;
        const diets = Object.values(state.weekData).filter((d) => d.diet).length;
        const cardio = Object.values(state.weekData).filter((d) => d.cardio).length;

        // Emoji obiettivo
        const goalEmoji = {
          'bulk': 'üí™',
          'cut': 'üî•',
          'maintain': '‚öñÔ∏è'
        };
        const goalName = {
          'bulk': 'Massa',
          'cut': 'Definizione',
          'maintain': 'Mantenimento'
        };

        return `
          <div class="space-y-4">
            <div class="bg-gradient-to-r from-orange-500 to-red-600 rounded-xl p-6 text-white shadow-lg">
              <div class="flex items-center justify-between mb-4">
                <div>
                  <h1 class="text-3xl font-bold">Winter Grind 2025</h1>
                  <p class="text-orange-100">${state.userName} - Settimana ${state.currentWeek}</p>
                  <p class="text-xs text-orange-200 mt-1">${goalEmoji[state.userGoal] || 'üí™'} Obiettivo: ${goalName[state.userGoal] || 'Massa'}</p>
                </div>
                ${icons.flame}
              </div>
              <div class="bg-white/20 rounded-lg p-4 backdrop-blur">
                <div class="flex justify-between items-center">
                  <div>
                    <p class="text-sm text-orange-100">Punti Settimanali</p>
                    <p class="text-4xl font-bold">${points}/100</p>
                  </div>
                  <div class="text-right">
                    <p class="text-2xl font-bold">${getStatusEmoji(points)}</p>
                    <p class="text-sm text-orange-100">Streak: ${state.streak} settimane</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="bg-white rounded-xl p-4 shadow">
              <div class="flex justify-between mb-2 text-sm">
                <span class="font-semibold">Progresso Settimanale</span>
                <span class="text-gray-600">${points}%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-3">
                <div class="h-3 rounded-full transition-all duration-500 ${points >= 90 ? "bg-green-500" : points >= 75 ? "bg-blue-500" : points >= 60 ? "bg-yellow-500" : "bg-red-500"}" style="width: ${points}%"></div>
              </div>
            </div>

            <div class="grid grid-cols-3 gap-3">
              <div class="bg-blue-50 rounded-xl p-4 text-center">
                <div class="text-blue-600 flex justify-center mb-2">${icons.dumbbell}</div>
                <p class="text-2xl font-bold text-blue-600">${workouts}</p>
                <p class="text-xs text-gray-600">Allenamenti</p>
              </div>
              <div class="bg-green-50 rounded-xl p-4 text-center">
                <div class="text-green-600 flex justify-center mb-2">${icons.apple}</div>
                <p class="text-2xl font-bold text-green-600">${diets}</p>
                <p class="text-xs text-gray-600">Dieta OK</p>
              </div>
              <div class="bg-purple-50 rounded-xl p-4 text-center">
                <div class="text-purple-600 flex justify-center mb-2">${icons.target}</div>
                <p class="text-2xl font-bold text-purple-600">${cardio}</p>
                <p class="text-xs text-gray-600">Cardio</p>
              </div>
            </div>

            <div class="bg-gradient-to-r from-purple-600 to-pink-600 rounded-xl p-6 text-white shadow-lg">
              <div class="flex justify-between items-center mb-3">
                <div>
                  <p class="text-sm text-purple-100 mb-1">üçï PUNTI SGARRO</p>
                  <p class="text-4xl font-bold">${state.pointsForSgarro}</p>
                  <p class="text-xs text-purple-100 mt-1">Accumulati (90+ punti = +1)</p>
                </div>
                <button onclick="useSgarro()" class="bg-white text-purple-600 px-6 py-3 rounded-lg font-bold active:scale-95 transition-transform shadow-lg ${state.pointsForSgarro > 0 ? '' : 'opacity-50'}">
                  USA SGARRO
                </button>
              </div>
              <div class="mt-3 pt-3 border-t border-purple-400">
                <p class="text-xs text-purple-100">
                  Ogni settimana con 90+ punti guadagni 1 sgarro. Usalo per un pasto libero senza sensi di colpa! üéâ
                </p>
              </div>
            </div>

            <div class="bg-gradient-to-r from-gray-800 to-gray-900 rounded-xl p-6 text-white shadow-lg">
              <p class="text-sm text-gray-400 mb-2">üí≠ MANTRA DEL GRIND</p>
              <p class="italic font-medium">"Mentre gli altri mollano, io costruisco. Questo inverno mi trasforma."</p>
            </div>
          </div>
        `;
      }

      function renderTracker() {
        let html = `
          <div class="space-y-3">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-2xl font-bold">Tracciamento Settimanale</h2>
              <button onclick="resetWeek()" class="bg-orange-500 text-white px-4 py-2 rounded-lg text-sm font-semibold active:scale-95 transition-transform">
                Nuova Settimana
              </button>
            </div>
        `;

        Object.entries(state.weekData).forEach(([day, data]) => {
          const dayName = dayNames[day];
          const workout = workoutSchedule[day];
          const isRestDay = day === "sunday";
          const pts = (data.workout ? 15 : 0) + (data.cardio ? 10 : 0) + (data.diet ? 3 : 0);

          html += `
            <div class="bg-white rounded-xl p-4 shadow">
              <div class="flex justify-between items-start mb-3">
                <div>
                  <h3 class="font-bold text-lg">${dayName}</h3>
                  ${workout ? `<p class="text-sm text-gray-600">${workout.name} - ${workout.focus}</p>` : ""}
                  ${isRestDay ? '<p class="text-sm text-gray-600">Riposo / Stretching</p>' : ""}
                </div>
                <span class="text-xs text-gray-500">${pts} pt</span>
              </div>
              <div class="flex gap-2">
          `;

          if (!isRestDay && (day === "wednesday" || day === "saturday")) {
            html += `
              <button onclick="toggleActivity('${day}', 'cardio')" 
                class="flex-1 py-3 rounded-lg font-semibold transition-all active:scale-95 ${data.cardio ? "bg-purple-500 text-white" : "bg-gray-100 text-gray-600"}">
                ${data.cardio ? icons.check : icons.circle}
                <span class="text-xs mt-1 block">Corsa</span>
              </button>
            `;
          }

          if (!isRestDay && day !== "wednesday" && day !== "saturday") {
            html += `
              <button onclick="toggleActivity('${day}', 'workout')" 
                class="flex-1 py-3 rounded-lg font-semibold transition-all active:scale-95 ${data.workout ? "bg-blue-500 text-white" : "bg-gray-100 text-gray-600"}">
                ${data.workout ? icons.check : icons.circle}
                <span class="text-xs mt-1 block">Palestra</span>
              </button>
            `;
          }

          html += `
            <button onclick="toggleActivity('${day}', 'diet')" 
              class="flex-1 py-3 rounded-lg font-semibold transition-all active:scale-95 ${data.diet ? "bg-green-500 text-white" : "bg-gray-100 text-gray-600"}">
              ${data.diet ? icons.check : icons.circle}
              <span class="text-xs mt-1 block">Dieta</span>
            </button>
          </div></div>
          `;
        });

        html += "</div>";
        return html;
      }

      function renderProgress() {
        let weightsHtml = "";
        if (state.savedWeights.length > 0) {
          weightsHtml = '<div class="space-y-2"><p class="text-sm font-semibold text-gray-600 mb-2">Storico:</p>';
          state.savedWeights.forEach((entry) => {
            weightsHtml += `
              <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                <span class="text-sm font-medium">Settimana ${entry.week}</span>
                <span class="font-bold text-blue-600">${entry.weight} kg</span>
              </div>
            `;
          });
          if (state.savedWeights.length >= 2) {
            const diff = (state.savedWeights[state.savedWeights.length - 1].weight - state.savedWeights[0].weight).toFixed(1);
            weightsHtml += `
              <div class="mt-3 p-3 bg-green-50 rounded-lg">
                <p class="text-sm font-semibold text-green-700">Variazione totale: ${diff} kg</p>
              </div>
            `;
          }
          weightsHtml += "</div>";
        }

        const points = calculatePoints();
        return `
          <div class="space-y-4">
            <h2 class="text-2xl font-bold mb-4">Progressi</h2>
            
            <div class="bg-white rounded-xl p-4 shadow">
              <h3 class="font-bold mb-3 flex items-center gap-2">
                <span class="text-blue-600">${icons.trend}</span>
                Tracker Peso
              </h3>
              <div class="flex gap-2 mb-4">
                <input type="number" step="0.1" placeholder="Es: 72.5" id="weightInput" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-lg">
                <button onclick="saveWeight()" class="bg-blue-500 text-white px-6 py-2 rounded-lg font-semibold active:scale-95 transition-transform">
                  Salva
                </button>
              </div>
              ${weightsHtml}
            </div>

            <div class="bg-white rounded-xl p-4 shadow">
              <h3 class="font-bold mb-3 flex items-center gap-2">
                <span class="text-yellow-600">${icons.award}</span>
                Achievements
              </h3>
              <div class="space-y-2">
                <div class="p-3 rounded-lg ${points >= 90 ? "bg-yellow-50 border-2 border-yellow-400" : "bg-gray-100"}">
                  <p class="font-semibold">üî• Bestia Mode</p>
                  <p class="text-xs text-gray-600">90+ punti questa settimana</p>
                </div>
                <div class="p-3 rounded-lg ${state.streak >= 4 ? "bg-yellow-50 border-2 border-yellow-400" : "bg-gray-100"}">
                  <p class="font-semibold">‚ö° 4 Settimane Streak</p>
                  <p class="text-xs text-gray-600">Mantieni la costanza (${state.streak}/4)</p>
                </div>
                <div class="p-3 rounded-lg ${state.currentWeek >= 8 ? "bg-yellow-50 border-2 border-yellow-400" : "bg-gray-100"}">
                  <p class="font-semibold">üíé Met√† Inverno</p>
                  <p class="text-xs text-gray-600">Completa 8 settimane (${state.currentWeek}/8)</p>
                </div>
                <div class="p-3 rounded-lg ${state.totalWeeksCompleted >= 12 ? "bg-yellow-50 border-2 border-yellow-400" : "bg-gray-100"}">
                  <p class="font-semibold">üëë Winter Grind Completo</p>
                  <p class="text-xs text-gray-600">12 settimane totali (${state.totalWeeksCompleted}/12)</p>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function renderWorkouts() {
        const workouts = [
          {
            day: "LUNED√å - Upper A (Push)",
            color: "blue",
            exercises: [
              ["Panca 15¬∞ Manubri", "36x5 | 34x6 | 34x5", "2'50\""],
              ["Chest press manubri inclinata", "3x10-12", "2'"],
              ["Military press manubri", "4x8-10", "2'"],
              ["Alzate laterali", "3x12-15", "1'30\""],
              ["French press", "3x10-12", "1'30\""],
              ["Push down corda", "3x12-15", "1'"],
            ],
          },
          {
            day: "MERCOLED√å - Lower A (Squat)",
            color: "green",
            exercises: [
              ["Squat bilanciere", "4x8-10", "3'"],
              ["Leg press", "3x12-15", "2'"],
              ["Affondi bulgari", "3x10/gamba", "2'"],
              ["Leg curl seduto", "3x12-15", "1'30\""],
              ["Calf press", "4x15-20", "1'"],
              ["Plank", '3x45-60"', "1'"],
            ],
          },
          {
            day: "VENERD√å - Upper B (Pull)",
            color: "purple",
            exercises: [
              ["Trazioni / Lat machine", "4x8-10", "2'30\""],
              ["Rematore bilanciere", "4x8-10", "2'30\""],
              ["Pulley basso", "3x10-12", "2'"],
              ["Face pull", "3x15", "1'30\""],
              ["Curl bilanciere", "3x10-12", "1'30\""],
              ["Curl martello", "3x12", "1'30\""],
            ],
          },
          {
            day: "SABATO - Lower B (Deadlift)",
            color: "orange",
            exercises: [
              ["Stacco rumeno", "4x8-10", "3'"],
              ["Pressa orizzontale", "3x12-15", "2'"],
              ["Stacchi sumo / Goblet squat", "3x10-12", "2'"],
              ["Leg extension", "3x12-15", "1'30\""],
              ["Calf in piedi", "4x15-20", "1'"],
              ["Russian twist", "3x20", "1'"],
            ],
          },
        ];

        let html = '<div class="space-y-3"><h2 class="text-2xl font-bold mb-4">Schede Allenamento</h2>';

        workouts.forEach((workout) => {
          html += `
            <div class="bg-white rounded-xl p-4 shadow">
              <h3 class="font-bold text-lg mb-3 text-${workout.color}-600">${workout.day}</h3>
              <div class="space-y-2 text-sm">
          `;
          workout.exercises.forEach((ex, idx) => {
            html += `
              <div class="py-2 ${idx < workout.exercises.length - 1 ? "border-b" : ""}">
                <div class="flex justify-between items-center">
                  <span class="font-medium">${ex[0]}</span>
                  <span class="font-bold text-gray-900">${ex[1]}</span>
                </div>
                <p class="text-xs text-gray-500 mt-1">Recupero: ${ex[2]}</p>
              </div>
            `;
          });
          html += "</div></div>";
        });

        html += "</div>";
        return html;
      }

      function renderNutrition() {
        const meals = [
          {
            icon: "üåÖ",
            name: "COLAZIONE (7:00)",
            kcal: "~ 400 kcal",
            items: ["80g fiocchi d'avena", "1 banana", "30g burro d'arachidi", "250ml latte intero"],
            optional: true,
          },
          {
            icon: "üçé",
            name: "SPUNTINO (10:30)",
            kcal: "~ 100 kcal",
            items: ["40g noci/mandorle", "1 mela", '<span class="text-gray-500 italic">Alt: Yogurt greco + miele</span>'],
            optional: true,
          },
          {
            icon: "üçù",
            name: "PRANZO (13:00)",
            kcal: "~900 kcal",
            items: ["100g riso/pasta (crudo)", "200g pollo/carne/pesce", "Verdure a volont√†", "1 cucchiaio olio EVO"],
          },
          {
            icon: "üçé",
            name: "MERENDA (15:00)",
            kcal: "~ 400 kcal",
            items: ["200/300g Yogurt Greco", "20g Cornflakes", '<span class="text-gray-500 italic">Alt: 200g Tacchino + Cracker</span>'],
          },
          {
            icon: "üçñ",
            name: "CENA (20:00)",
            kcal: "~700 kcal",
            items: ["200/250g carne/pesce", "200g patate / 100g pane", "Verdure abbondanti", "1 cucchiaio olio EVO"],
          },
          {
            icon: "üåô",
            name: "PRENANNA (21:00)",
            kcal: "~250 kcal",
            items: ["200g Yogurt Greco"],
            optional: true,
          },
        ];

        let html = `
          <div class="space-y-3">
            <h2 class="text-2xl font-bold mb-4">Piano Alimentare</h2>
            
            <div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl p-4 text-white shadow-lg mb-4">
              <h3 class="font-bold text-lg mb-2">üéØ I Tuoi Target Giornalieri</h3>
              <div class="grid grid-cols-3 gap-3 text-center">
                <div><p class="text-2xl font-bold">${state.macros.protein}g</p><p class="text-xs text-green-100">Proteine</p></div>
                <div><p class="text-2xl font-bold">${state.macros.carbs}g</p><p class="text-xs text-green-100">Carboidrati</p></div>
                <div><p class="text-2xl font-bold">${state.macros.fats}g</p><p class="text-xs text-green-100">Grassi</p></div>
              </div>
              <p class="text-center mt-3 text-sm font-bold">~${state.macros.calories} kcal/giorno</p>
              <p class="text-center text-xs text-green-100 mt-1">Personalizzato per il tuo obiettivo ${state.userGoal === 'bulk' ? 'üí™ Massa' : state.userGoal === 'cut' ? 'üî• Definizione' : '‚öñÔ∏è Mantenimento'}</p>
            </div>
        `;

        meals.forEach((meal) => {
          html += `
            <div class="bg-white rounded-xl p-4 shadow">
              <h3 class="font-bold mb-2">${meal.icon} ${meal.name}</h3>
              <p class="text-sm text-gray-600 mb-2">${meal.kcal}${meal.optional ? " - Opzionale" : ""}</p>
              <div class="space-y-1 text-sm">
          `;
          meal.items.forEach((item) => {
            html += `<p>‚Ä¢ ${item}</p>`;
          });
          html += "</div></div>";
        });

        html += `
          <div class="bg-blue-50 rounded-xl p-4 mt-4">
            <h3 class="font-bold mb-2 text-blue-800">üí° Tips Veloci</h3>
            <div class="space-y-1 text-sm text-blue-900">
              <p>‚úì Meal prep domenica: cucina per 3-4 giorni</p>
              <p>‚úì Bevi 2.5-3L acqua al giorno</p>
              <p>‚úì 80% pulito, 20% flessibile weekend</p>
              <p>‚úì Pesati solo luned√¨ mattina a digiuno</p>
              <p>‚úì Obiettivo: ${state.userGoal === 'bulk' ? '+0.3-0.5kg al mese' : state.userGoal === 'cut' ? '-0.5-0.7kg a settimana' : 'mantieni il peso stabile'}</p>
            </div>
          </div>
          
          <div class="bg-orange-50 rounded-xl p-4 border-2 border-orange-200">
            <p class="text-xs text-orange-800 font-semibold mb-1">üì± Aggiorna i tuoi macro</p>
            <p class="text-xs text-orange-700">Usa <code class="bg-orange-200 px-1 rounded">/setup</code> nel bot per ricalcolare macro in base a peso/obiettivo aggiornati!</p>
          </div>
        </div>
        `;

        return html;
      }

      function renderCalendar() {
        const days = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"];

        function getDayColor(day, points) {
          if (day === "sunday") {
            if (points >= 3) return "bg-green-400";
            return "bg-red-300";
          } else if (day === "wednesday" || day === "saturday") {
            if (points >= 13) return "bg-green-400";
            if (points >= 10) return "bg-yellow-300";
            return "bg-red-300";
          } else {
            if (points >= 18) return "bg-green-400";
            if (points >= 15) return "bg-yellow-300";
            return "bg-red-300";
          }
        }

        let currentWeekHtml = '<div class="grid grid-cols-7 gap-2 mb-4">';

        days.forEach((day) => {
          const dayData = state.weekData[day] || { workout: false, diet: false, cardio: false };
          const points = (dayData.workout ? 15 : 0) + (dayData.cardio ? 10 : 0) + (dayData.diet ? 3 : 0);
          const colorClass = getDayColor(day, points);
          const dayName = dayNames[day].slice(0, 3);

          currentWeekHtml += `
            <div class="${colorClass} text-white font-bold rounded-lg py-3 text-center shadow">
              <div class="text-xs">${dayName}</div>
              <div class="text-lg mt-1">${points}</div>
            </div>
          `;
        });

        currentWeekHtml += "</div>";

        let historyHtml = "";
        if (state.weekHistory.length > 0) {
          historyHtml = '<h3 class="font-bold mb-3 text-gray-700">üìÖ Settimane Precedenti</h3>';
          const reversedHistory = [...state.weekHistory].reverse();

          reversedHistory.forEach((week) => {
            historyHtml += `
              <div class="bg-gray-50 rounded-lg p-4 mb-3 border-2 border-gray-200">
                <div class="flex justify-between items-center mb-3">
                  <span class="font-bold text-gray-800">Settimana ${week.weekNumber}</span>
                  <div class="text-right">
                    <span class="text-2xl">${week.status}</span>
                    <div class="text-sm text-gray-600">${week.totalPoints}/100 pt</div>
                  </div>
                </div>
                <div class="grid grid-cols-7 gap-1">
            `;

            days.forEach((day) => {
              const dayData = week.data[day] || { workout: false, diet: false, cardio: false };
              const points = (dayData.workout ? 15 : 0) + (dayData.cardio ? 10 : 0) + (dayData.diet ? 3 : 0);
              const colorClass = getDayColor(day, points);
              const dayName = dayNames[day].slice(0, 3);

              historyHtml += `
                <div class="${colorClass} text-white font-semibold rounded py-2 text-center text-xs">
                  <div>${dayName}</div>
                  <div class="text-xs">${points}</div>
                </div>
              `;
            });

            historyHtml += "</div></div>";
          });
        }

        return `
          <div class="space-y-4">
            <h2 class="text-2xl font-bold mb-4">üìÜ Calendario Completo</h2>
            
            <div class="bg-white rounded-xl p-4 shadow-lg border-2 border-orange-500">
              <div class="flex justify-between items-center mb-3">
                <h3 class="font-bold text-lg">üî• Settimana ${state.currentWeek} (Corrente)</h3>
                <span class="text-2xl">${getStatusEmoji(calculatePoints())}</span>
              </div>
              ${currentWeekHtml}
              <div class="text-center mt-2">
                <span class="text-lg font-bold text-orange-600">${calculatePoints()}/100 punti</span>
              </div>
            </div>
            
            ${historyHtml ? `<div class="bg-white rounded-xl p-4 shadow">${historyHtml}</div>` : ""}
            
            <div class="bg-blue-50 rounded-xl p-4">
              <h3 class="font-bold mb-3 text-blue-800">üìä Legenda Colori</h3>
              <div class="space-y-2 text-sm text-blue-900">
                <div class="flex items-center gap-2">
                  <div class="w-6 h-6 bg-green-400 rounded"></div>
                  <span><strong>Verde</strong> = Giorno perfetto (max punti possibili)</span>
                </div>
                <div class="flex items-center gap-2">
                  <div class="w-6 h-6 bg-yellow-300 rounded"></div>
                  <span><strong>Giallo</strong> = Parziale (almeno allenamento)</span>
                </div>
                <div class="flex items-center gap-2">
                  <div class="w-6 h-6 bg-red-300 rounded"></div>
                  <span><strong>Rosso</strong> = Incompleto o saltato</span>
                </div>
              </div>
              <div class="mt-4 pt-4 border-t border-blue-200 text-xs text-blue-700">
                <p><strong>Domenica:</strong> Max 3pt (solo dieta)</p>
                <p><strong>Mer/Sab:</strong> Max 13pt (corsa 10 + dieta 3)</p>
                <p><strong>Altri giorni:</strong> Max 18pt (palestra 15 + dieta 3)</p>
              </div>
            </div>
          </div>
        `;
      }

      function renderNavigation() {
        return `
          <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-2 py-2 max-w-md mx-auto">
            <div class="flex justify-around">
              <button onclick="setView('dashboard')" class="flex flex-col items-center p-2 rounded-lg transition-colors ${state.currentView === "dashboard" ? "text-orange-600 bg-orange-50" : "text-gray-600"}">
                ${icons.trophy}
                <span class="text-xs mt-1">Home</span>
              </button>
              <button onclick="setView('tracker')" class="flex flex-col items-center p-2 rounded-lg transition-colors ${state.currentView === "tracker" ? "text-orange-600 bg-orange-50" : "text-gray-600"}">
                ${icons.calendar}
                <span class="text-xs mt-1">Tracker</span>
              </button>
              <button onclick="setView('workouts')" class="flex flex-col items-center p-2 rounded-lg transition-colors ${state.currentView === "workouts" ? "text-orange-600 bg-orange-50" : "text-gray-600"}">
                ${icons.dumbbell}
                <span class="text-xs mt-1">Schede</span>
              </button>
              <button onclick="setView('nutrition')" class="flex flex-col items-center p-2 rounded-lg transition-colors ${state.currentView === "nutrition" ? "text-orange-600 bg-orange-50" : "text-gray-600"}">
                ${icons.apple}
                <span class="text-xs mt-1">Dieta</span>
              </button>
              <button onclick="setView('calendar')" class="flex flex-col items-center p-2 rounded-lg transition-colors ${state.currentView === "calendar" ? "text-orange-600 bg-orange-50" : "text-gray-600"}">
                ${icons.calendar}
                <span class="text-xs mt-1">Calendar</span>
              </button>
              <button onclick="setView('progress')" class="flex flex-col items-center p-2 rounded-lg transition-colors ${state.currentView === "progress" ? "text-orange-600 bg-orange-50" : "text-gray-600"}">
                ${icons.trend}
                <span class="text-xs mt-1">Progressi</span>
              </button>
            </div>
          </div>
        `;
      }

      function render() {
        let content = "";

        switch (state.currentView) {
          case "dashboard":
            content = renderDashboard();
            break;
          case "tracker":
            content = renderTracker();
            break;
          case "progress":
            content = renderProgress();
            break;
          case "calendar":
            content = renderCalendar();
            break;
          case "workouts":
            content = renderWorkouts();
            break;
          case "nutrition":
            content = renderNutrition();
            break;
        }

        document.getElementById("root").innerHTML = `
          <div class="max-w-md mx-auto bg-gray-50 min-h-screen pb-20">
            <div class="p-4">
              ${content}
            </div>
            ${renderNavigation()}
          </div>
        `;
      }

      initApp();
    </script>
  </body>
</html>